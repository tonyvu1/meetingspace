<header>
  <% include partials/nav.ejs %>
</header>

<body>


  <div class="row">
    <h1>Welcome to Twilio Video quickstart</h1>
    <div id="remote-media"></div>
    <div id="controls">
      <div id="preview">
        <p class="instructions">Hello Beautiful</p>
        <div id="local-media"></div>
        <button id="button-preview">Preview My Camera</button>
      </div>
     
      <div id="log"></div>
    </div>
  </div>

  <div id="room-controls">
    <p class="instructions">Room Name:</p>
    <input id="room-name" type="text" placeholder="Enter a room name" />
    <button id="button-join">Join Room</button>
    <button id="button-leave">Leave Room</button>
  </div>
  <script src="/style/jquery/dist/jquery.js"></script>
  <script src="//media.twiliocdn.com/sdk/js/video/v1/twilio-video.min.js"></script>


</body>

<script>
  // TWILIO VIDEO

  const Video = Twilio.Video;


  var activeRoom;
  var previewTracks;
  var identity;
  var roomName;

  // Attach the Track to the DOM.
  function attachTrack(track, container) {
    container.appendChild(track.attach());
  }

  // Attach array of Tracks to the DOM.
  function attachTracks(tracks, container) {
    tracks.forEach(function(track) {
      attachTrack(track, container);
    });
  }

  // Detach given track from the DOM
  function detachTrack(track) {
    track.detach().forEach(function(element) {
      element.remove();
    });
  }

  // A new RemoteTrack was published to the Room.
  function trackPublished(publication, container) {
    if (publication.isSubscribed) {
      attachTrack(publication.track, container);
    }
    publication.on("subscribed", function(track) {
      log("Subscribed to " + publication.kind + " track");
      attachTrack(track, container);
    });
    publication.on("unsubscribed", detachTrack);
  }

  // A RemoteTrack was unpublished from the Room.
  function trackUnpublished(publication) {
    log(publication.kind + " track was unpublished.");
  }

  // A new RemoteParticipant joined the Room
  function participantConnected(participant, container) {
    participant.tracks.forEach(function(publication) {
      trackPublished(publication, container);
    });
    participant.on("trackPublished", function(publication) {
      trackPublished(publication, container);
    });
    participant.on("trackUnpublished", trackUnpublished);
  }

  // Detach the Participant's Tracks from the DOM.
  function detachParticipantTracks(participant) {
    var tracks = getTracks(participant);
    tracks.forEach(detachTrack);
  }

  // When we are about to transition away from this page, disconnect
  // from the room, if joined.
  window.addEventListener("beforeunload", leaveRoomIfJoined);

  // Obtain a token from the server in order to connect to the Room.
  $.getJSON("/token", function(data) {
    identity = data.identity;
    document.getElementById("room-controls").style.display = "block";

    // Bind button to join Room.
    document.getElementById("button-join").onclick = function() {
      roomName = document.getElementById("room-name").value;
      if (!roomName) {
        alert("Please enter a room name.");
        return;
      }

      console.log('just work..............')
      log("Joining room '" + roomName + "'...");
      var connectOptions = {
        name: roomName,
        logLevel: "debug"
      };

      if (previewTracks) {
        connectOptions.tracks = previewTracks;
      }

      // Join the Room with the token from the server and the
      // LocalParticipant's Tracks.
      Video.connect(data.token, connectOptions).then(roomJoined, function(
        error
      ) {
        log("Could not connect to Twilio: " + error.message);
      });
    };

    // Bind button to leave Room.
    document.getElementById("button-leave").onclick = function() {
      log("Leaving room...");
      activeRoom.disconnect();
    };
  });

  // Get the Participant's Tracks.
  function getTracks(participant) {
    return Array.from(participant.tracks.values())
      .filter(function(publication) {
        return publication.track;
      })
      .map(function(publication) {
        return publication.track;
      });
  }

  // Successfully connected!
  function roomJoined(room) {
    window.room = activeRoom = room;

    log("Joined as '" + identity + "'");
    document.getElementById("button-join").style.display = "none";
    document.getElementById("button-leave").style.display = "inline";

    // Attach LocalParticipant's Tracks, if not already attached.
    var previewContainer = document.getElementById("local-media");
    if (!previewContainer.querySelector("video")) {
      attachTracks(getTracks(room.localParticipant), previewContainer);
    }

    // Attach the Tracks of the Room's Participants.
    var remoteMediaContainer = document.getElementById("remote-media");
    room.participants.forEach(function(participant) {
      log("Already in Room: '" + participant.identity + "'");
      participantConnected(participant, remoteMediaContainer);
    });

    // When a Participant joins the Room, log the event.
    room.on("participantConnected", function(participant) {
      log("Joining: '" + participant.identity + "'");
      participantConnected(participant, remoteMediaContainer);
    });

    // When a Participant leaves the Room, detach its Tracks.
    room.on("participantDisconnected", function(participant) {
      log("RemoteParticipant '" + participant.identity + "' left the room");
      detachParticipantTracks(participant);
    });

    // Once the LocalParticipant leaves the room, detach the Tracks
    // of all Participants, including that of the LocalParticipant.
    room.on("disconnected", function() {
      log("Left");
      if (previewTracks) {
        previewTracks.forEach(function(track) {
          track.stop();
        });
        previewTracks = null;
      }
      detachParticipantTracks(room.localParticipant);
      room.participants.forEach(detachParticipantTracks);
      activeRoom = null;
      document.getElementById("button-join").style.display = "inline";
      document.getElementById("button-leave").style.display = "none";
    });
  }

  // Preview LocalParticipant's Tracks.
  document.getElementById("button-preview").onclick = function() {
    var localTracksPromise = previewTracks
      ? Promise.resolve(previewTracks)
      : Video.createLocalTracks();

    localTracksPromise.then(
      function(tracks) {
        window.previewTracks = previewTracks = tracks;
        var previewContainer = document.getElementById("local-media");
        if (!previewContainer.querySelector("video")) {
          attachTracks(tracks, previewContainer);
        }
      },
      function(error) {
        console.error("Unable to access local media", error);
        log("Unable to access Camera and Microphone");
      }
    );
  };

  // Activity log.
  function log(message) {
    var logDiv = document.getElementById("log");
    logDiv.innerHTML += "<p>&gt;&nbsp;" + message + "</p>";
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // Leave Room.
  function leaveRoomIfJoined() {
    if (activeRoom) {
      activeRoom.disconnect();
    }
  }
</script>

<style>
  div#remote-media {
    height: 43%;
    width: 100%;
    background-color: #fff;
    text-align: center;
    margin: auto;
  }

  div#remote-media video {
    border: 1px solid #272726;
    margin: 3em 2em;
    height: 70%;
    max-width: 27% !important;
    background-color: #272726;
    background-repeat: no-repeat;
  }

  div#controls {
    padding: 3em;
    max-width: 1200px;
    margin: 0 auto;
  }

  div#controls div {
    float: left;
  }

  div#controls div#room-controls,
  div#controls div#preview {
    width: 16em;
    margin: 0 1.5em;
    text-align: center;
  }

  div#controls p.instructions {
    text-align: left;
    margin-bottom: 1em;
    font-family: Helvetica-LightOblique, Helvetica, sans-serif;
    font-style: oblique;
    font-size: 1.25em;
    color: #777776;
  }

  div#controls button {
    width: 15em;
    height: 2.5em;
    margin-top: 1.75em;
    border-radius: 1em;
    font-family: "Helvetica Light", Helvetica, sans-serif;
    font-size: 0.8em;
    font-weight: lighter;
    outline: 0;
  }

  div#controls div#room-controls input {
    font-family: Helvetica-LightOblique, Helvetica, sans-serif;
    font-style: oblique;
    font-size: 1em;
  }

  div#controls button:active {
    position: relative;
    top: 1px;
  }

  div#controls div#preview div#local-media {
    width: 270px;
    height: 202px;
    border: 1px solid #cececc;
    box-sizing: border-box;
    background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjgwcHgiIGhlaWdodD0iODBweCIgdmlld0JveD0iMCAwIDgwIDgwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIj4KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggMy4zLjEgKDEyMDAyKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5GaWxsIDUxICsgRmlsbCA1MjwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPjwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHNrZXRjaDp0eXBlPSJNU1BhZ2UiPgogICAgICAgIDxnIGlkPSJjdW1tYWNrIiBza2V0Y2g6dHlwZT0iTVNMYXllckdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTU5LjAwMDAwMCwgLTE3NDYuMDAwMDAwKSIgZmlsbD0iI0ZGRkZGRiI+CiAgICAgICAgICAgIDxnIGlkPSJGaWxsLTUxLSstRmlsbC01MiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTU5LjAwMDAwMCwgMTc0Ni4wMDAwMDApIiBza2V0Y2g6dHlwZT0iTVNTaGFwZUdyb3VwIj4KICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik0zOS42ODYsMC43MyBDMTcuODUsMC43MyAwLjA4NSwxOC41IDAuMDg1LDQwLjMzIEMwLjA4NSw2Mi4xNyAxNy44NSw3OS45MyAzOS42ODYsNzkuOTMgQzYxLjUyMiw3OS45MyA3OS4yODcsNjIuMTcgNzkuMjg3LDQwLjMzIEM3OS4yODcsMTguNSA2MS41MjIsMC43MyAzOS42ODYsMC43MyBMMzkuNjg2LDAuNzMgWiBNMzkuNjg2LDEuNzMgQzYxLjAwNSwxLjczIDc4LjI4NywxOS4wMiA3OC4yODcsNDAuMzMgQzc4LjI4Nyw2MS42NSA2MS4wMDUsNzguOTMgMzkuNjg2LDc4LjkzIEMxOC4zNjcsNzguOTMgMS4wODUsNjEuNjUgMS4wODUsNDAuMzMgQzEuMDg1LDE5LjAyIDE4LjM2NywxLjczIDM5LjY4NiwxLjczIEwzOS42ODYsMS43MyBaIiBpZD0iRmlsbC01MSI+PC9wYXRoPgogICAgICAgICAgICAgICAgPHBhdGggZD0iTTQ3Ljk2LDUzLjMzNSBMNDcuOTYsNTIuODM1IEwyMC4wOTMsNTIuODM1IEwyMC4wOTMsMjcuODI1IEw0Ny40NiwyNy44MjUgTDQ3LjQ2LDM4LjI1NSBMNTkuMjc5LDMwLjgwNSBMNTkuMjc5LDQ5Ljg1NSBMNDcuNDYsNDIuNDA1IEw0Ny40Niw1My4zMzUgTDQ3Ljk2LDUzLjMzNSBMNDcuOTYsNTIuODM1IEw0Ny45Niw1My4zMzUgTDQ4LjQ2LDUzLjMzNSBMNDguNDYsNDQuMjE1IEw2MC4yNzksNTEuNjY1IEw2MC4yNzksMjguOTk1IEw0OC40NiwzNi40NDUgTDQ4LjQ2LDI2LjgyNSBMMTkuMDkzLDI2LjgyNSBMMTkuMDkzLDUzLjgzNSBMNDguNDYsNTMuODM1IEw0OC40Niw1My4zMzUgTDQ3Ljk2LDUzLjMzNSIgaWQ9IkZpbGwtNTIiPjwvcGF0aD4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+);
    background-position: center;
    background-repeat: no-repeat;
    margin: 0 auto;
  }

  div#controls div#preview div#local-media video {
    max-width: 100%;
    max-height: 100%;
    border: none;
  }

  div#controls div#preview button#button-preview {
    background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE3cHgiIGhlaWdodD0iMTJweCIgdmlld0JveD0iMCAwIDE3IDEyIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIj4KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggMy4zLjEgKDEyMDAyKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5GaWxsIDM0PC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+PC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCIgc2tldGNoOnR5cGU9Ik1TUGFnZSI+CiAgICAgICAgPGcgaWQ9ImN1bW1hY2siIHNrZXRjaDp0eXBlPSJNU0xheWVyR3JvdXAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xMjUuMDAwMDAwLCAtMTkwOS4wMDAwMDApIiBmaWxsPSIjMEEwQjA5Ij4KICAgICAgICAgICAgPHBhdGggZD0iTTEzNi40NzEsMTkxOS44NyBMMTM2LjQ3MSwxOTE5LjYyIEwxMjUuNzY3LDE5MTkuNjIgTDEyNS43NjcsMTkxMC4wOCBMMTM2LjIyMSwxOTEwLjA4IEwxMzYuMjIxLDE5MTQuMTUgTDE0MC43ODUsMTkxMS4yNyBMMTQwLjc4NSwxOTE4LjQyIEwxMzYuMjIxLDE5MTUuNTUgTDEzNi4yMjEsMTkxOS44NyBMMTM2LjQ3MSwxOTE5Ljg3IEwxMzYuNDcxLDE5MTkuNjIgTDEzNi40NzEsMTkxOS44NyBMMTM2LjcyMSwxOTE5Ljg3IEwxMzYuNzIxLDE5MTYuNDUgTDE0MS4yODUsMTkxOS4zMyBMMTQxLjI4NSwxOTEwLjM3IEwxMzYuNzIxLDE5MTMuMjQgTDEzNi43MjEsMTkwOS41OCBMMTI1LjI2NywxOTA5LjU4IEwxMjUuMjY3LDE5MjAuMTIgTDEzNi43MjEsMTkyMC4xMiBMMTM2LjcyMSwxOTE5Ljg3IEwxMzYuNDcxLDE5MTkuODciIGlkPSJGaWxsLTM0IiBza2V0Y2g6dHlwZT0iTVNTaGFwZUdyb3VwIj48L3BhdGg+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=)
      1em center no-repeat #fff;
    border: none;
    padding-left: 1.5em;
  }

  div#controls div#log {
    border: 1px solid #686865;
  }

  div#controls div#room-controls {
    display: none;
  }

  div#controls div#room-controls input {
    width: 100%;
    height: 2.5em;
    padding: 0.5em;
    display: block;
  }

  div#controls div#room-controls button {
    color: #fff;
    background: 0 0;
    border: 1px solid #686865;
  }

  div#controls div#room-controls button#button-leave {
    display: none;
  }

  div#controls div#log {
    width: 35%;
    height: 9.5em;
    margin-top: 2.75em;
    text-align: left;
    padding: 1.5em;
    float: right;
    overflow-y: scroll;
  }

  div#controls div#log p {
    color: #000000;
    font-family: "Share Tech Mono", "Courier New", Courier, fixed-width;
    font-size: 1.25em;
    line-height: 1.25em;
    margin-left: 1em;
    text-indent: -1.25em;
    width: 90%;
  }

  #classroom-container {
    height: 100vh;
    justify-content: center;
  }

  #chat-body {
    border: 1px solid rgb(165, 165, 165);

    box-shadow: rgba(156, 172, 172, 0.2) 0px 2px 2px,
      rgba(156, 172, 172, 0.2) 0px 4px 4px, rgba(156, 172, 172, 0.2) 0px 8px 8px,
      rgba(156, 172, 172, 0.2) 0px 16px 16px,
      rgba(156, 172, 172, 0.2) 0px 32px 32px,
      rgba(156, 172, 172, 0.2) 0px 64px 64px;
  }

  .chat {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .chat li {
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px dotted #b3a9a9;
  }

  .chat li .chat-body p {
    margin: 0;
    color: #777777;
  }

  .body-panel {
    overflow-y: scroll;
    height: 250px;
  }

  video {
    box-shadow: rgba(156, 172, 172, 0.2) 0px 2px 2px,
      rgba(156, 172, 172, 0.2) 0px 4px 4px, rgba(156, 172, 172, 0.2) 0px 8px 8px,
      rgba(156, 172, 172, 0.2) 0px 16px 16px,
      rgba(156, 172, 172, 0.2) 0px 32px 32px,
      rgba(156, 172, 172, 0.2) 0px 64px 64px;
  }
</style>

<script id="new-message" type="text/template">
  <li id="{{id}}" class="right clearfix">
      <div class="chat-body clearfix">
          <p>
              {{body}}
          </p>
      </div>
  </li>
</script>

<script>
  // TWILIO CHAT
  $(document).ready(function() {
    let username = "tony";
    let chatChannel;

    getToken()
      .then(token => {
        console.log("returned token is ", token);
        return Twilio.Chat.Client.create(token, { logLevel: "debug" });
      })
      .then(client => {
        getChannelDescriptor(client)
          .then(channel => client.getChannelByUniqueName("chat34channel"))
          .then(channel => channel.join())
          .then(channel => {
            chatSetupCompleted();
            chatChannel = channel;
            channel.on("messageAdded", onMessageAdded);
            activateChatBox();
          });
      })
      .catch(
        error =>
          console.log("error setting up twilio", error) || chatSetupFailed()
      );

    function getToken() {
      return fetch(`/token?username=${username}`)
        .then(response => {
          if (response.ok) {
            return response.text();
          }

          throw new Error("Network response was not ok.");
        })
        .catch(error => console.log("Error fetching token", error) || error);
    }

    function getChannelDescriptor(chatClient) {
      return chatClient
        .getPublicChannelDescriptors()
        .then(function(paginator) {
          if (paginator.items.length > 0) return paginator.items[0];
          else {
            chatClient
              .createChannel({
                uniqueName: "chat3channel",
                friendlyName: "chat3channel",
                isPrivate: false
              })
              .then(function(newChannel) {
                console.log("Created general channel:");
                console.log(newChannel);
                return newChannel;
              });
          }
        })
        .then(channel => channel)
        .catch(error => console.log("error getting channel", error) || error);
    }

    /*
       .getChannelByUniqueName("chat3channel")
          .then(channel => channel)
          .catch(error => console.log("error getting channel", error) || error);
  
      */

    function onMessageAdded(message) {
      let template = $("#new-message").html();
      template = template.replace(
        "{{body}}",
        `<b>${message.author}:</b> ${message.body}`
      );

      $(".chat").append(template);
    }

    function chatSetupCompleted() {
      let template = $("#new-message").html();
      template = template.replace("{{body}}", "<b>Welcome to class!</b>");

      $(".chat").append(template);
    }

    function chatSetupFailed() {
      let template = $("#new-message").html();
      template = template.replace(
        "{{body}}",
        "<b>Chat Setup Failed. Contact Admin.</b>"
      );

      $(".chat").append(template);
    }

    function activateChatBox() {
      $("#message").removeAttr("disabled");
      $("#btn-chat").click(function() {
        const message = $("#message").val();
        $("#message").val("");

        //send message
        chatChannel.sendMessage(message);
      });

      $("#message").on("keydown", function(e) {
        if (e.keyCode === 13) {
          $("#btn-chat").click();
        }
      });
    }
  });
</script>







